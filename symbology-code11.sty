\ProvidesPackage{symbology-code11}
  [2017/05/03 v1.0 Construct Code 11 barcodes]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Code 11
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\define@cmdkeys{code11}[sy@oo@]{xwidth,height,font}{}
\define@choicekey+{code11}{checksum}[\sy@oo@checksum\sy@oo@checksum@nl]{none,auto,C,K}{}
	{\sy@error{Requested checksum `#1' invalid.\MessageBreak
	           Valid values: none, auto, C, K}}

\setkeys{code11}{xwidth=\p@,height=2\baselineskip,checksum=auto,font=\ttfamily}

\csdef{sy@code11}{%
	\dimen@=\sy@oo@xwidth\relax
	\dimen\tw@=\sy@oo@height\relax
	\sy@make@color@box{`b}{\dimen@}{\dimen\tw@}\z@\z@{\sy@darkcolor}%
	\sy@make@color@box{`B}{2\dimen@}{\dimen\tw@}\z@\z@{\sy@darkcolor}%
	\sy@make@color@box{`s}{\dimen@}{\dimen\tw@}\z@\z@{\sy@lightcolor}%
	\sy@make@color@box{`S}{2\dimen@}{\dimen\tw@}\z@\z@{\sy@lightcolor}%
	% Set c to the length in order to compute the checksums.
	% gf@a and gf@b will be the running totals for the C and K checksums.
	% a and b will be the corresponding weights.
	\sy@c=\z@
	\sy@foreach@token{\advance\sy@c\@ne}%
	\mathchardef\sy@len=\sy@c
	\sy@gf@a=\z@
	\sy@gf@b=\z@
	\sy@a=\sy@mod\sy@c{10}%
	\sy@b=\sy@mod{\sy@c+\@ne}9%
	\hbox{%
		\sy@oo@symbol{11}% Start
		\sy@foreach@token{%
			\sy@c=\expandafter`\sy@token\relax
			\sy@check@range\sy@c{`0}{`9}%
			\ifsy@inrange
				\advance\sy@c-`0%
			\else\ifnum\sy@c=`-%
				\sy@c=10
			\else
				\sy@error{Invalid character `\sy@token' for Code 11}%
			\fi\fi
			\sy@oo@symbol\sy@c
			% Update the checksums.
			\ifnum\sy@a=\z@ \sy@a=10 \fi
			\ifnum\sy@b=\z@ \sy@b=9 \fi
			% gf@a += c*a
			% gf@b += c*b
			\advance\sy@gf@a \numexpr \sy@c*\sy@a \relax
			\advance\sy@gf@b \numexpr \sy@c*\sy@b \relax
			\advance\sy@a\m@ne
			\advance\sy@b\m@ne
		}%
		\ifnum\sy@a=\z@\else \sy@error{Internal error: Check digit C weight nonzero!}\fi
		\ifnum\sy@b=\@ne\else \sy@error{Internal error: Check digit K weight not 1!}\fi
		\sy@gf@a=\sy@mod\sy@gf@a{11}%
		\sy@gf@b=\sy@mod{\sy@gf@b+\sy@gf@a}{11}%
		\ifcase\sy@oo@checksum@nl
		\or % auto
			\sy@oo@symbol\sy@gf@a
			\ifnum\sy@len>9
				\sy@oo@symbol\sy@gf@b
			\fi
		\or % C
			\sy@oo@symbol\sy@gf@a
		\or % K
			\sy@oo@symbol\sy@gf@a
			\sy@oo@symbol\sy@gf@b
		\fi
		\sy@oo@symbol{12}% Stop
	}%
}

\def\sy@oo@symbol#1{%
	\count@=#1\relax
	\expandafter\sy@oo@draw
		\ifcase\count@
	              bsbsB% 0
		\or   BsbsB% 1
		\or   bSbsB% 2
		\or   BSbsb% 3
		\or   bsBsB% 4
		\or   BsBsb% 5
		\or   bSBsb% 6
		\or   bsbSB% 7
		\or   BsbSb% 8
		\or   Bsbsb% 9
		\or   bsBsb% -
		\else bsBSb% Start/Stop
		\fi
	\ifnum\count@<12
		\unhcopy`s%
	\fi
}

\def\sy@oo@draw#1#2#3#4#5{%
	\unhcopy`#1%
	\unhcopy`#2%
	\unhcopy`#3%
	\unhcopy`#4%
	\unhcopy`#5%
}

